// =============================================================================
// AGG VWAP — Aggregated Multi-Anchor VWAP
// Reverse-engineered from: Rolling VWAP 1-4 + Upper/Lower Bands columns
//
// CONFIDENCE: ~75% (upgraded after backtest — TP formula confirmed)
//   High confidence:
//     - 4 independently anchored VWAPs, each from a different historical date
//     - Bands 3 and 4 use ±1 standard deviation (confirmed: symmetric, dynamic)
//     - Bands 1 and 2 are empty in exported data (intentionally disabled or
//       anchors too old for meaningful SD display)
//   Medium confidence:
//     - Exact anchor dates are inferred, not confirmed
//     - VWAP4 (~91,489 at Apr 26, 2025) is consistent with Apr 20, 2024 Halving
//     - VWAP1/VWAP2 decay slower → longer anchors (possibly 2022-2023 cycle events)
//   Lower confidence:
//     - Whether "Rolling" means rolling window vs. anchored carry-forward
//     - Which exact dates the original indicator uses as anchors
//
// COLUMN MAPPING:
//   Rolling VWAP 1  → vwap1  (longest anchor, slowest-changing, no bands)
//   Rolling VWAP 2  → vwap2  (second anchor, no bands)
//   Rolling VWAP 3  → vwap3  (third anchor, ±1 SD bands present)
//   Rolling VWAP 4  → vwap4  (shortest/most recent anchor, ±1 SD bands present)
//   Upper Band 1-2  → empty  (not plotted in original)
//   Lower Band 1-2  → empty  (not plotted in original)
//   Upper Band 3    → vwap3 + sd3
//   Lower Band 3    → vwap3 - sd3
//   Upper Band 4    → vwap4 + sd4
//   Lower Band 4    → vwap4 - sd4
//
// DEFAULT ANCHOR DATE CANDIDATES (all configurable):
//   VWAP1: Nov 21, 2022 — BTC cycle low (~$15.5k)
//   VWAP2: Jan 11, 2024 — US Spot BTC ETF approval (~$46k)
//   VWAP3: Aug 05, 2024 — BTC flash crash low (~$49k)
//   VWAP4: Apr 20, 2024 — BTC Halving (~$65k)  ← highest confidence
// =============================================================================

//@version=5
indicator("AGG VWAP — Multi-Anchor", shorttitle="AGG-VWAP", overlay=true)

// ── Anchor date inputs ────────────────────────────────────────────────────────
var string g_anchors = "Anchor Dates"
var string g_disp    = "Display"
var string g_color   = "Colors"

// Timestamps: year, month, day
anchor1_y = input.int(2022, "VWAP 1 Anchor Year",  minval=2009, group=g_anchors)
anchor1_m = input.int(11,   "VWAP 1 Anchor Month", minval=1, maxval=12, group=g_anchors)
anchor1_d = input.int(21,   "VWAP 1 Anchor Day",   minval=1, maxval=31, group=g_anchors)

anchor2_y = input.int(2024, "VWAP 2 Anchor Year",  minval=2009, group=g_anchors)
anchor2_m = input.int(1,    "VWAP 2 Anchor Month", minval=1, maxval=12, group=g_anchors)
anchor2_d = input.int(11,   "VWAP 2 Anchor Day",   minval=1, maxval=31, group=g_anchors)

anchor3_y = input.int(2024, "VWAP 3 Anchor Year",  minval=2009, group=g_anchors)
anchor3_m = input.int(8,    "VWAP 3 Anchor Month", minval=1, maxval=12, group=g_anchors)
anchor3_d = input.int(5,    "VWAP 3 Anchor Day",   minval=1, maxval=31, group=g_anchors)

anchor4_y = input.int(2024, "VWAP 4 Anchor Year",  minval=2009, group=g_anchors)
anchor4_m = input.int(4,    "VWAP 4 Anchor Month", minval=1, maxval=12, group=g_anchors)
anchor4_d = input.int(20,   "VWAP 4 Anchor Day",   minval=1, maxval=31, group=g_anchors)

show_bands34 = input.bool(true,  "Show SD Bands (VWAP 3 & 4)", group=g_disp)
show_bands12 = input.bool(false, "Show SD Bands (VWAP 1 & 2)", group=g_disp,
  tooltip="Bands 1 & 2 are empty in the original CSV export — enable only for reference.")

// ── Colors ────────────────────────────────────────────────────────────────────
c1      = input.color(color.new(#FF6B6B, 0),  "VWAP 1",     group=g_color)
c2      = input.color(color.new(#FFD93D, 0),  "VWAP 2",     group=g_color)
c3      = input.color(color.new(#6BCB77, 0),  "VWAP 3",     group=g_color)
c4      = input.color(color.new(#4D96FF, 0),  "VWAP 4",     group=g_color)
c_band  = input.color(color.new(#78909C, 30), "Band fill",   group=g_color)

// ── Anchored VWAP helper ──────────────────────────────────────────────────────
// Returns the VWAP + SD from a given anchor (year, month, day)
// Accumulates from first bar on or after the anchor date.
vwap_from_anchor(anchor_y, anchor_m, anchor_d) =>
    var float _tpv  = 0.0
    var float _vol  = 0.0
    var float _tp2v = 0.0

    _tp = close  // Backtest confirmed: close outperforms (H+L+C)/3 by 70x for VWAP accuracy

    _is_anchor = year(time) == anchor_y and month(time) == anchor_m and dayofmonth(time) == anchor_d
    _reset     = _is_anchor or (barstate.isfirst and
                   (year(time) > anchor_y or
                    (year(time) == anchor_y and month(time) > anchor_m) or
                    (year(time) == anchor_y and month(time) == anchor_m and dayofmonth(time) > anchor_d)))

    if _reset
        _tpv  := _tp  * volume
        _vol  := volume
        _tp2v := _tp  * _tp * volume
    else if year(time) > anchor_y or
            (year(time) == anchor_y and month(time) > anchor_m) or
            (year(time) == anchor_y and month(time) == anchor_m and dayofmonth(time) >= anchor_d)
        _tpv  += _tp  * volume
        _vol  += volume
        _tp2v += _tp  * _tp * volume

    float _vwap = _vol > 0 ? _tpv / _vol : na
    float _var  = _vol > 0 ? math.max(_tp2v / _vol - _vwap * _vwap, 0.0) : na
    float _sd   = not na(_var) ? math.sqrt(_var) : na

    [_vwap, _sd]

// ── Calculate all four VWAPs ──────────────────────────────────────────────────
[vwap1, sd1] = vwap_from_anchor(anchor1_y, anchor1_m, anchor1_d)
[vwap2, sd2] = vwap_from_anchor(anchor2_y, anchor2_m, anchor2_d)
[vwap3, sd3] = vwap_from_anchor(anchor3_y, anchor3_m, anchor3_d)
[vwap4, sd4] = vwap_from_anchor(anchor4_y, anchor4_m, anchor4_d)

// ── Plots ─────────────────────────────────────────────────────────────────────
// VWAP lines
p1 = plot(vwap1, "VWAP 1", c1, 2)
p2 = plot(vwap2, "VWAP 2", c2, 2)
p3 = plot(vwap3, "VWAP 3", c3, 2)
p4 = plot(vwap4, "VWAP 4", c4, 2)

// SD Bands — VWAP 3 (original CSV has bands 3 and 4 populated)
p3u = plot(show_bands34 ? vwap3 + sd3 : na, "Upper Band 3", color.new(c3, 40), 1)
p3l = plot(show_bands34 ? vwap3 - sd3 : na, "Lower Band 3", color.new(c3, 40), 1)
fill(p3u, p3l, color.new(c3, 90), "Band 3 Fill")

// SD Bands — VWAP 4
p4u = plot(show_bands34 ? vwap4 + sd4 : na, "Upper Band 4", color.new(c4, 40), 1)
p4l = plot(show_bands34 ? vwap4 - sd4 : na, "Lower Band 4", color.new(c4, 40), 1)
fill(p4u, p4l, color.new(c4, 90), "Band 4 Fill")

// SD Bands — VWAP 1 & 2 (optional, empty in original)
plot(show_bands12 ? vwap1 + sd1 : na, "Upper Band 1", color.new(c1, 60), 1)
plot(show_bands12 ? vwap1 - sd1 : na, "Lower Band 1", color.new(c1, 60), 1)
plot(show_bands12 ? vwap2 + sd2 : na, "Upper Band 2", color.new(c2, 60), 1)
plot(show_bands12 ? vwap2 - sd2 : na, "Lower Band 2", color.new(c2, 60), 1)

// ── Alerts ────────────────────────────────────────────────────────────────────
alertcondition(ta.cross(close, vwap4), "Price x VWAP 4 (Halving)", "Price crossed VWAP anchored at Halving")
alertcondition(ta.cross(close, vwap3), "Price x VWAP 3",           "Price crossed VWAP 3")
alertcondition(ta.cross(close, vwap2), "Price x VWAP 2",           "Price crossed VWAP 2")
alertcondition(ta.cross(close, vwap1), "Price x VWAP 1",           "Price crossed VWAP 1 (longest anchor)")
