// =============================================================================
// VWAP + Value Areas — Multi-Timeframe
// Supports: Yearly, Quarterly, Monthly, Weekly periods
// Auto mode selects period based on chart timeframe:
//   Daily or higher  -> Yearly
//   > 4H up to Daily -> Quarterly
//   1H to 4H         -> Monthly
//   Below 1H         -> Weekly
// =============================================================================

//@version=6
indicator("VWAP + Value Areas", shorttitle="VWAP-VA", overlay=true, max_lines_count=500, max_labels_count=500)

// ── Timeframe ─────────────────────────────────────────────────────────────────
string tf_mode = input.string("Auto", "Timeframe", options=["Auto", "Yearly", "Quarterly", "Monthly", "Weekly"], group="Timeframe")

// ── Display ───────────────────────────────────────────────────────────────────
bool show_va     = input.bool(true,  "Show Value Area (+/-1 SD)", group="Display")
bool show_prev   = input.bool(true,  "Show Previous Period",      group="Display")
bool show_shade  = input.bool(true,  "Show Value Area Shading",   group="Display")
bool show_labels = input.bool(true,  "Show Labels",               group="Display")
bool show_sd2    = input.bool(false, "Show +/-2 SD Bands",        group="Display")
bool show_sd3    = input.bool(false, "Show +/-3 SD Bands",        group="Display")

// ── Developing period colours ─────────────────────────────────────────────────
color c_vwap = input.color(color.new(#2196F3, 0),  "VWAP Line",        group="Colours - Developing Period")
color c_vah  = input.color(color.new(#4CAF50, 0),  "VAH Line",         group="Colours - Developing Period")
color c_val  = input.color(color.new(#F44336, 0),  "VAL Line",         group="Colours - Developing Period")
color c_sd2  = input.color(color.new(#FF9800, 30), "+/-2 SD Lines",    group="Colours - Developing Period")
color c_sd3  = input.color(color.new(#9C27B0, 30), "+/-3 SD Lines",    group="Colours - Developing Period")
color c_fill = input.color(color.new(#2196F3, 85), "Value Area Fill",  group="Colours - Developing Period")
color c_lbg  = input.color(color.new(#131722, 70), "Label Background", group="Colours - Developing Period")
color c_ltxt = input.color(color.new(#FFFFFF, 0),  "Label Text",       group="Colours - Developing Period")

// ── Previous period colours ───────────────────────────────────────────────────
color c_pvwap = input.color(color.new(#9E9E9E, 40), "Prev VWAP Line",        group="Colours - Previous Period")
color c_pvah  = input.color(color.new(#9E9E9E, 40), "Prev VAH Line",         group="Colours - Previous Period")
color c_pval  = input.color(color.new(#9E9E9E, 40), "Prev VAL Line",         group="Colours - Previous Period")
color c_pfill = input.color(color.new(#9E9E9E, 90), "Prev Value Area Fill",  group="Colours - Previous Period")
color c_plbg  = input.color(color.new(#131722, 70), "Prev Label Background", group="Colours - Previous Period")
color c_pltxt = input.color(color.new(#9E9E9E, 0),  "Prev Label Text",       group="Colours - Previous Period")

// ── Effective timeframe ───────────────────────────────────────────────────────
// timeframe.in_seconds() returns seconds per bar: 86400=1D, 14400=4H, 3600=1H
int tfs = timeframe.in_seconds()

string eff_tf = "Weekly"
if tf_mode != "Auto"
    eff_tf := tf_mode
else if tfs >= 86400
    eff_tf := "Yearly"
else if tfs > 14400
    eff_tf := "Quarterly"
else if tfs >= 3600
    eff_tf := "Monthly"

// ── Period boundary detection ─────────────────────────────────────────────────
bool new_period = barstate.isfirst

if not barstate.isfirst
    if eff_tf == "Yearly"
        new_period := year(time) != year(time[1])
    else if eff_tf == "Quarterly"
        int qc = month(time)    <= 3 ? 1 : month(time)    <= 6 ? 2 : month(time)    <= 9 ? 3 : 4
        int qp = month(time[1]) <= 3 ? 1 : month(time[1]) <= 6 ? 2 : month(time[1]) <= 9 ? 3 : 4
        new_period := qc != qp or year(time) != year(time[1])
    else if eff_tf == "Monthly"
        new_period := month(time) != month(time[1]) or year(time) != year(time[1])
    else
        new_period := weekofyear(time) != weekofyear(time[1]) or year(time) != year(time[1])

// ── VWAP accumulators ─────────────────────────────────────────────────────────
var float cum_tpv  = 0.0
var float cum_vol  = 0.0
var float cum_tp2v = 0.0
var float prev_vwap_val = na
var float prev_sd_val   = na

float tp = close

if new_period
    if cum_vol > 0
        float pv   = cum_tpv / cum_vol
        float pvar = math.max(cum_tp2v / cum_vol - pv * pv, 0.0)
        prev_vwap_val := pv
        prev_sd_val   := math.sqrt(pvar)
    cum_tpv  := tp * volume
    cum_vol  := volume
    cum_tp2v := tp * tp * volume
else
    cum_tpv  += tp * volume
    cum_vol  += volume
    cum_tp2v += tp * tp * volume

float vwap_val = cum_tpv / cum_vol
float vari     = math.max(cum_tp2v / cum_vol - vwap_val * vwap_val, 0.0)
float sd_val   = math.sqrt(vari)
float vah_val  = vwap_val + sd_val
float val_val  = vwap_val - sd_val

// ── Extension lines for developing period (dashed, extend to RHS) ────────────
var line ext_vwap_ln = na
var line ext_vah_ln  = na
var line ext_val_ln  = na

if new_period and not barstate.isfirst
    if not na(ext_vwap_ln)
        line.delete(ext_vwap_ln)
    if not na(ext_vah_ln)
        line.delete(ext_vah_ln)
    if not na(ext_val_ln)
        line.delete(ext_val_ln)
    ext_vwap_ln := na
    ext_vah_ln  := na
    ext_val_ln  := na

if barstate.islast
    if na(ext_vwap_ln)
        ext_vwap_ln := line.new(bar_index, vwap_val, bar_index + 1, vwap_val, extend=extend.right, color=c_vwap, style=line.style_dashed, width=1)
    else
        line.set_xy1(ext_vwap_ln, bar_index, vwap_val)
        line.set_xy2(ext_vwap_ln, bar_index + 1, vwap_val)

    if show_va
        if na(ext_vah_ln)
            ext_vah_ln := line.new(bar_index, vah_val, bar_index + 1, vah_val, extend=extend.right, color=c_vah, style=line.style_dashed, width=1)
        else
            line.set_xy1(ext_vah_ln, bar_index, vah_val)
            line.set_xy2(ext_vah_ln, bar_index + 1, vah_val)

        if na(ext_val_ln)
            ext_val_ln := line.new(bar_index, val_val, bar_index + 1, val_val, extend=extend.right, color=c_val, style=line.style_dashed, width=1)
        else
            line.set_xy1(ext_val_ln, bar_index, val_val)
            line.set_xy2(ext_val_ln, bar_index + 1, val_val)

// ── Plots ─────────────────────────────────────────────────────────────────────
p_vwap = plot(vwap_val,               "VWAP",   c_vwap, 2)
p_vah  = plot(show_va ? vah_val : na, "VAH +1", c_vah,  1)
p_val  = plot(show_va ? val_val : na, "VAL -1", c_val,  1)
fill(p_vah, p_val, color=show_shade and show_va ? c_fill : na)

plot(show_sd2 ? vwap_val + 2.0 * sd_val : na, "+2 SD", c_sd2, 1)
plot(show_sd2 ? vwap_val - 2.0 * sd_val : na, "-2 SD", c_sd2, 1)
plot(show_sd3 ? vwap_val + 3.0 * sd_val : na, "+3 SD", c_sd3, 1)
plot(show_sd3 ? vwap_val - 3.0 * sd_val : na, "-3 SD", c_sd3, 1)

// Previous period lines
float prev_vah = not na(prev_vwap_val) and not na(prev_sd_val) ? prev_vwap_val + prev_sd_val : na
float prev_val = not na(prev_vwap_val) and not na(prev_sd_val) ? prev_vwap_val - prev_sd_val : na

bool show_prev_vwap = show_prev and not na(prev_vwap_val)
bool show_prev_va   = show_prev and show_va and not na(prev_vah)

p_pvwap = plot(show_prev_vwap              ? prev_vwap_val : na, "Prev VWAP",   c_pvwap, 1, plot.style_linebr)
p_pvah  = plot(show_prev_va               ? prev_vah       : na, "Prev VAH +1", c_pvah,  1, plot.style_linebr)
p_pval  = plot(show_prev_va               ? prev_val       : na, "Prev VAL -1", c_pval,  1, plot.style_linebr)
fill(p_pvah, p_pval, color=show_shade and show_prev and not na(prev_vah) ? c_pfill : na)

// ── Labels (positioned 30% from RHS of visible range) ────────────────────────
var label lbl_dvwap = na
var label lbl_dvah  = na
var label lbl_dval  = na
var label lbl_pvwap = na
var label lbl_pvah  = na
var label lbl_pval  = na

if show_labels and barstate.islast
    int lbl_x = math.round(chart.left_visible_bar_time + (chart.right_visible_bar_time - chart.left_visible_bar_time) * 0.7)

    label.delete(lbl_dvwap)
    lbl_dvwap := label.new(lbl_x, vwap_val, "VWAP: " + str.tostring(vwap_val, format.mintick), xloc=xloc.bar_time, style=label.style_label_left, color=c_lbg, textcolor=c_ltxt, size=size.small)

    if show_va
        label.delete(lbl_dvah)
        lbl_dvah := label.new(lbl_x, vah_val, "DVAH: " + str.tostring(vah_val, format.mintick), xloc=xloc.bar_time, style=label.style_label_left, color=c_lbg, textcolor=c_ltxt, size=size.small)
        label.delete(lbl_dval)
        lbl_dval := label.new(lbl_x, val_val, "DVAL: " + str.tostring(val_val, format.mintick), xloc=xloc.bar_time, style=label.style_label_left, color=c_lbg, textcolor=c_ltxt, size=size.small)

    if show_prev and not na(prev_vwap_val)
        label.delete(lbl_pvwap)
        lbl_pvwap := label.new(lbl_x, prev_vwap_val, "PVWAP: " + str.tostring(prev_vwap_val, format.mintick), xloc=xloc.bar_time, style=label.style_label_left, color=c_plbg, textcolor=c_pltxt, size=size.small)
        if show_va and not na(prev_vah) and not na(prev_val)
            label.delete(lbl_pvah)
            lbl_pvah := label.new(lbl_x, prev_vah, "PVAH: " + str.tostring(prev_vah, format.mintick), xloc=xloc.bar_time, style=label.style_label_left, color=c_plbg, textcolor=c_pltxt, size=size.small)
            label.delete(lbl_pval)
            lbl_pval := label.new(lbl_x, prev_val, "PVAL: " + str.tostring(prev_val, format.mintick), xloc=xloc.bar_time, style=label.style_label_left, color=c_plbg, textcolor=c_pltxt, size=size.small)

// ── Alerts ────────────────────────────────────────────────────────────────────
alertcondition(ta.cross(close, vwap_val),      "Price x VWAP",      "Price crossed VWAP")
alertcondition(ta.cross(close, vah_val),       "Price x VAH",       "Price crossed VAH (+1 SD)")
alertcondition(ta.cross(close, val_val),       "Price x VAL",       "Price crossed VAL (-1 SD)")
alertcondition(ta.cross(close, prev_vwap_val), "Price x Prev VWAP", "Price crossed Previous Period VWAP")
