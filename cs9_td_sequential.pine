// =============================================================================
// Lowkeigh-9s — Count-Step Display (TD Sequential Style)
// Reverse-engineered from: 16 "Shapes" binary columns in CS9 CSV export
//
// CONFIDENCE: ~35% (revised down after backtest)
//   Backtest findings (20-row CSV sample):
//   - Standard TD Sequential (close < close[4], 9 consecutive) → ZERO matches
//   - All s8-fire bars DO satisfy close < close[4] individually ✓
//   - All s0-fire bars DO satisfy close > close[4] individually ✓
//   - Conclusion: the condition fires per-qualifying-bar but the count rule
//     cannot be determined from only 20 data rows
//
// COLUMN INTERPRETATION (revised after backtest):
//   sN = 1 means the CURRENT BAR'S count step is N+1
//   s0 = count is at step 1   (count reset / new sequence start)
//   s1 = count is at step 2
//   s2 = count is at step 3
//   s4 = count is at step 5
//   s8 = count is at step 9 → SETUP COMPLETE (most important signal)
//   s9–s15 → countdown steps 10–16 (sell countdown in original data)
//
// OBSERVED SEQUENCES IN DATA:
//   Bars 0-3 (consecutive): s1→s2→s4→s8 (counts 2,3,5,9 on 4 straight days)
//   → Means: 4 consecutive bars all qualified; count was at 1 before bar 0
//   → Gaps in labeling (count 4 not shown) = normal TD display (only certain
//     counts labeled, others advance silently)
//
//   s0 and s8 alternate every 1-7 bars — count resets after s8, restarts
//
// WHAT IS UNKNOWN:
//   The exact qualifying condition cannot be confirmed with only 20 rows.
//   Standard close[N] < close[N-4] and N-consecutive patterns both fail.
//   Best hypothesis: a variant of close vs close[4] with a sliding/rolling
//   count window rather than requiring strict consecutive bars.
//
// THIS SCRIPT implements the closest approximation: count bars where
// close vs close[lookback] satisfies the condition; track current count;
// display it per bar. "9" fires on the 9th qualifying bar in a run.
// =============================================================================

//@version=6
indicator("Lowkeigh-9s", shorttitle="Lowkeigh-9s", overlay=true, max_labels_count=500)

// ── Inputs ───────────────────────────────────────────────────────────────────
var string g_setup = "Setup"
var string g_cd    = "Countdown"
var string g_disp  = "Display"

setup_lb     = input.int(4,    "Setup lookback (bars)",   minval=1, maxval=10, group=g_setup,
                 tooltip="Comparison: close vs close[lookback]. TD default = 4.")
show_9       = input.bool(true, "Show Setup 9 label",      group=g_setup)
show_cd      = input.bool(true, "Show Countdown progress", group=g_cd)

c_buy9   = input.color(color.new(#00C853, 0),  "Buy Setup 9",     group=g_disp)
c_sell9  = input.color(color.new(#D50000, 0),  "Sell Setup 9",    group=g_disp)
c_num    = input.color(color.new(#B0BEC5, 0),  "Count 1–8",       group=g_disp)
c_cd_buy = input.color(color.new(#00BCD4, 0),  "Buy Countdown",   group=g_disp)
c_cd_sel = input.color(color.new(#FF6F00, 0),  "Sell Countdown",  group=g_disp)
txt_size_input = input.string("small", "Text size", options=["tiny", "small", "normal", "large", "huge"], group=g_disp,
                 tooltip="Size of count numbers on chart. Default is 'small'.")

// ── Text size helpers ─────────────────────────────────────────────────────────
// Convert string input to Pine Script size constant
_txt_size = switch txt_size_input
    "tiny"   => size.tiny
    "small"  => size.small
    "normal" => size.normal
    "large"  => size.large
    "huge"   => size.huge
    => size.small

// Setup 9 label is always one step larger than the selected size
_txt_size_9 = switch txt_size_input
    "tiny"   => size.small
    "small"  => size.normal
    "normal" => size.large
    "large"  => size.huge
    "huge"   => size.huge
    => size.normal

// ── Setup counting ────────────────────────────────────────────────────────────
// Buy  setup: close < close[setup_lb]  → bearish exhaustion / potential bounce
// Sell setup: close > close[setup_lb]  → bullish exhaustion / potential top
//
// NOTE: Backtest confirmed that ALL s8-fire (bearish) bars satisfy
//       close < close[4] and ALL s0-fire (bullish) bars satisfy close > close[4].
//       However, the 9-consecutive-qualifying-bar rule had zero matches in
//       the 20-row sample, suggesting a sliding/windowed variant may be in use.
//       This implementation uses the same per-bar condition and tracks the count.
var int buy_count  = 0
var int sell_count = 0

buy_cond  = close < close[setup_lb]
sell_cond = close > close[setup_lb]

// Increment count on qualifying bar; reset opposing count
if buy_cond
    buy_count  += 1
    sell_count := 0
else if sell_cond
    sell_count += 1
    buy_count  := 0
else
    buy_count  := 0
    sell_count := 0

// Setup 9 fires when count reaches 9
buy_setup_9  = buy_count  == 9
sell_setup_9 = sell_count == 9

// Perfect 9 detection (calculated before reset, while count == 9)
// A "perfect" buy setup 9 occurs when the close of bar 8 or bar 9 is <=
// the low of bar 6 or bar 7 of the setup (standard TD Sequential definition).
_perf_buy_9  = buy_count  == 9 and (close <= low[2] or close <= low[3] or close[1] <= low[2] or close[1] <= low[3])
_perf_sell_9 = sell_count == 9 and (close >= high[2] or close >= high[3] or close[1] >= high[2] or close[1] >= high[3])

// Count continues past 9; only resets to 0 naturally when the condition fails
// (handled in the buy_cond/sell_cond/else block above)

// ── Countdown ─────────────────────────────────────────────────────────────────
// TD Buy Countdown  : close <= low[2]   — fires after a buy setup completes
// TD Sell Countdown : close >= high[2]  — fires after a sell setup completes
var bool in_buy_cd  = false
var bool in_sell_cd = false
var int  buy_cd     = 0
var int  sell_cd    = 0

// Activate countdown on setup 9 completion
if buy_setup_9
    in_buy_cd  := true
    in_sell_cd := false
    buy_cd     := 0

if sell_setup_9
    in_sell_cd := true
    in_buy_cd  := false
    sell_cd    := 0

// Increment countdown on qualifying bars
if in_buy_cd and close <= low[2]
    buy_cd += 1
    if buy_cd >= 13
        in_buy_cd := false
        buy_cd    := 0

if in_sell_cd and close >= high[2]
    sell_cd += 1
    if sell_cd >= 13
        in_sell_cd := false
        sell_cd    := 0

// ── Labels — Setup counts ─────────────────────────────────────────────────────
// Labels are pinned above/below bars (yloc.abovebar / yloc.belowbar) so they
// appear at a consistent visual offset from candles rather than floating at
// exact price levels.
// Show counts 1, 8, 9 only — plain number text, no dots or shapes

if buy_count == 1
    label.new(bar_index, na, "1",
      yloc=yloc.belowbar,
      color=color.new(color.black, 100), textcolor=c_num,
      style=label.style_none, size=_txt_size)

if buy_count == 8
    label.new(bar_index, na, "8",
      yloc=yloc.belowbar,
      color=color.new(color.black, 100), textcolor=c_num,
      style=label.style_none, size=_txt_size)

if show_9 and buy_count == 9
    _lbl = _perf_buy_9 ? "9P" : "9"
    label.new(bar_index, na, _lbl,
      yloc=yloc.belowbar,
      color=color.new(color.black, 100), textcolor=c_buy9,
      style=label.style_none, size=_txt_size_9)

if sell_count == 1
    label.new(bar_index, na, "1",
      yloc=yloc.abovebar,
      color=color.new(color.black, 100), textcolor=c_num,
      style=label.style_none, size=_txt_size)

if sell_count == 8
    label.new(bar_index, na, "8",
      yloc=yloc.abovebar,
      color=color.new(color.black, 100), textcolor=c_num,
      style=label.style_none, size=_txt_size)

if show_9 and sell_count == 9
    _lbl = _perf_sell_9 ? "9P" : "9"
    label.new(bar_index, na, _lbl,
      yloc=yloc.abovebar,
      color=color.new(color.black, 100), textcolor=c_sell9,
      style=label.style_none, size=_txt_size_9)

// ── Labels — Countdown counts ─────────────────────────────────────────────────
// Countdown bars are labeled as cd+9 (first countdown bar = 10, second = 11, …)
// Show counts 10–20 only (buy_cd / sell_cd values 1–11)

if show_cd and in_buy_cd and buy_cd >= 1
    _cd_num = buy_cd + 9
    if _cd_num <= 20
        label.new(bar_index, na, str.tostring(_cd_num),
          yloc=yloc.belowbar,
          color=color.new(color.black, 100), textcolor=c_cd_buy,
          style=label.style_none, size=_txt_size)

if show_cd and in_sell_cd and sell_cd >= 1
    _cd_num = sell_cd + 9
    if _cd_num <= 20
        label.new(bar_index, na, str.tostring(_cd_num),
          yloc=yloc.abovebar,
          color=color.new(color.black, 100), textcolor=c_cd_sel,
          style=label.style_none, size=_txt_size)

// ── Alerts ───────────────────────────────────────────────────────────────────
alertcondition(buy_setup_9,   "Lowkeigh-9s Buy Setup 9",        "Lowkeigh-9s: Buy Setup 9 complete — potential reversal up")
alertcondition(sell_setup_9,  "Lowkeigh-9s Sell Setup 9",       "Lowkeigh-9s: Sell Setup 9 complete — potential reversal down")
alertcondition(sell_cd == 13, "Lowkeigh-9s Sell Countdown 13",  "Lowkeigh-9s: Sell Countdown 13 — high-conviction bearish exhaustion")
alertcondition(buy_cd  == 13, "Lowkeigh-9s Buy Countdown 13",   "Lowkeigh-9s: Buy Countdown 13 — high-conviction bullish exhaustion")
